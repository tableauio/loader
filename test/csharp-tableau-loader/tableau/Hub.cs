// <auto-generated>
// Code generated by protoc-gen-csharp-tableau-loader. DO NOT EDIT.
// versions:
// - protoc-gen-csharp-tableau-loader v0.1.0
// - protoc                           v3.19.3
// </auto-generated>
#nullable enable
using pb = global::Google.Protobuf;
namespace Tableau
{
    internal class MessagerContainer
    {
        public Dictionary<string, Messager> MessagerMap;
        public DateTime LastLoadedTime;
        public HeroConf? HeroConf;
        public HeroBaseConf? HeroBaseConf;
        public ItemConf? ItemConf;
        public PatchReplaceConf? PatchReplaceConf;
        public PatchMergeConf? PatchMergeConf;
        public RecursivePatchConf? RecursivePatchConf;
        public ActivityConf? ActivityConf;
        public ChapterConf? ChapterConf;
        public ThemeConf? ThemeConf;
        public TaskConf? TaskConf;

        public MessagerContainer(in Dictionary<string, Messager>? messagerMap = null)
        {
            MessagerMap = messagerMap ?? [];
            LastLoadedTime = DateTime.Now;
            if (messagerMap != null)
            {
                HeroConf = Get<HeroConf>();
                HeroBaseConf = Get<HeroBaseConf>();
                ItemConf = Get<ItemConf>();
                PatchReplaceConf = Get<PatchReplaceConf>();
                PatchMergeConf = Get<PatchMergeConf>();
                RecursivePatchConf = Get<RecursivePatchConf>();
                ActivityConf = Get<ActivityConf>();
                ChapterConf = Get<ChapterConf>();
                ThemeConf = Get<ThemeConf>();
                TaskConf = Get<TaskConf>();
            }
        }

        public T? Get<T>() where T : Messager, IMessagerName => MessagerMap.TryGetValue(T.Name(), out var messager) ? (T)messager : null;
    }

    public class HubOptions
    {
        public Func<string, bool>? Filter { get; set; }
    }

    public class Hub(HubOptions? options = null)
    {
        private MessagerContainer _messagerContainer = new();
        private readonly HubOptions _options = options ?? new HubOptions();

        public bool Load(string dir, Format fmt, in Load.Options? options = null)
        {
            var messagerMap = NewMessagerMap();
            foreach (var messager in messagerMap.Values)
            {
                if (!messager.Load(dir, fmt, options))
                {
                    return false;
                }
            }
            var tmpHub = new Hub();
            tmpHub.SetMessagerMap(messagerMap);
            foreach (var messager in messagerMap.Values)
            {
                if (!messager.ProcessAfterLoadAll(tmpHub))
                {
                    return false;
                }
            }
            SetMessagerMap(messagerMap);
            return true;
        }

        public ref Dictionary<string, Messager> GetMessagerMap() => ref _messagerContainer.MessagerMap;

        public void SetMessagerMap(in Dictionary<string, Messager> map) => _messagerContainer = new MessagerContainer(map);

        public T? Get<T>() where T : Messager, IMessagerName => _messagerContainer.Get<T>();

        public HeroConf? GetHeroConf() => _messagerContainer.HeroConf;

        public HeroBaseConf? GetHeroBaseConf() => _messagerContainer.HeroBaseConf;

        public ItemConf? GetItemConf() => _messagerContainer.ItemConf;

        public PatchReplaceConf? GetPatchReplaceConf() => _messagerContainer.PatchReplaceConf;

        public PatchMergeConf? GetPatchMergeConf() => _messagerContainer.PatchMergeConf;

        public RecursivePatchConf? GetRecursivePatchConf() => _messagerContainer.RecursivePatchConf;

        public ActivityConf? GetActivityConf() => _messagerContainer.ActivityConf;

        public ChapterConf? GetChapterConf() => _messagerContainer.ChapterConf;

        public ThemeConf? GetThemeConf() => _messagerContainer.ThemeConf;

        public TaskConf? GetTaskConf() => _messagerContainer.TaskConf;

        public DateTime GetLastLoadedTime() => _messagerContainer.LastLoadedTime;

        private Dictionary<string, Messager> NewMessagerMap()
        {
            var messagerMap = new Dictionary<string, Messager>();
            foreach (var kv in Registry.Registrar)
            {
                if (_options.Filter?.Invoke(kv.Key) ?? true)
                {
                    messagerMap[kv.Key] = kv.Value();
                }
            }
            return messagerMap;
        }
    }

    public class Registry
    {
        internal static readonly Dictionary<string, Func<Messager>> Registrar = [];

        public static void Register<T>() where T : Messager, IMessagerName, new() => Registrar[T.Name()] = () => new T();

        public static void Init()
        {
            Register<HeroConf>();
            Register<HeroBaseConf>();
            Register<ItemConf>();
            Register<PatchReplaceConf>();
            Register<PatchMergeConf>();
            Register<RecursivePatchConf>();
            Register<ActivityConf>();
            Register<ChapterConf>();
            Register<ThemeConf>();
            Register<TaskConf>();
        }
    }
}
